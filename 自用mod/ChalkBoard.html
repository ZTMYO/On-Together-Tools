<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>On-Together黑板绘图编辑器</title>
    <style>
        :root {
            /* 粉笔颜色*/
            --chalk-1: #ffdfdb;
            /* 粉色 */
            --chalk-2: #fec77f;
            /* 橙黄 */
            --chalk-3: #ff9981;
            /* 橘红 */
            --chalk-4: #dae190;
            /* 浅黄绿 */
            --chalk-5: #c8daed;
            /* 浅蓝灰 */

            /* 黑板与边框颜色*/
            --board-bg: #6c684d;
            --board-frame: #cf724c;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 16px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #ffffff;
            color: #222222;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            text-align: center;
        }

        .subtitle {
            font-size: 12px;
            text-align: center;
            color: #666666;
            margin-top: 4px;
        }

        .layout {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
            align-items: center;
        }

        /* 底部水平工具栏（放在黑板下方） */
        .side-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            max-width: 1000px;
            border-top: 1px solid #dddddd;
            padding: 8px 4px 0;
            background-color: #ffffff;
            order: 1;
        }

        .panel-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .panel-section {
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .panel-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        button,
        label.btn {
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #cccccc;
            background-color: #f7f7f7;
            color: #222222;
            padding: 3px 8px;
            font-size: 12px;
        }

        button:hover,
        label.btn:hover {
            background-color: #ececec;
        }

        button.active {
            border-color: #0078d4;
            background-color: #e5f2ff;
        }

        input[type="file"] {
            display: none;
        }

        .color-swatch {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid #aaaaaa;
            display: inline-block;
        }

        .color-label {
            font-size: 11px;
        }

        #info {
            font-size: 11px;
            color: #666666;
            min-height: 14px;
        }

        /* 黑板区域：只保留你指定的黑板与边框颜色 */
        .board-frame {
            padding: 10px;
            border-radius: 10px;
            background-color: var(--board-frame);
            display: inline-block;
            order: 0;
            /* 黑板在上方 */
        }


        #canvasWrapper {
            border-radius: 4px;
            border: 1px solid #333333;
            overflow: auto;
            background: transparent;
            max-width: 100%;
            max-height: calc(100vh - 140px);
        }

        canvas {
            display: block;
            image-rendering: pixelated;
            background: transparent;
        }

        .hint {
            font-size: 11px;
            color: #666666;
            line-height: 1.5;
        }
    </style>
</head>

<body>
    <header style="text-align:center;">
        <h1>On-Together 粉笔黑板编辑器</h1>
        <div id="info" style="margin-top:4px;"></div>
    </header>
    <div class="layout">
        <aside class="side-panel">
            <div class="panel-section">

                <div class="panel-row">
                    <label class="btn" for="fileInput" title="导入 dat" style="display:flex;align-items:center;gap:4px;">
                        <svg viewBox="0 0 1024 1024" width="20" height="20" aria-hidden="true">
                            <path
                                d="M746.666667 469.333333H554.666667V213.333333l42.666666 42.666667 51.2 51.2L746.666667 213.333333l59.733333 59.733334-98.133333 98.133333 21.333333 21.333333 38.4 34.133334 42.666667 42.666666h-64zM512 213.333333v85.333334H298.666667v426.666666h426.666666v-213.333333h85.333334v298.666667H213.333333V213.333333h298.666667z"
                                fill="#000000"></path>
                        </svg>
                        <span>导入</span>
                    </label>
                    <input id="fileInput" type="file" accept=".dat" />
                    <button id="saveBtn" class="btn" title="导出 dat" style="display:flex;align-items:center;gap:4px;">
                        <svg viewBox="0 0 1024 1024" width="20" height="20" aria-hidden="true">
                            <path
                                d="M712.533333 371.2l-128 128-59.733333-59.733333 128-128L597.333333 256l-42.666666-42.666667h256v256l-42.666667-42.666666-55.466667-55.466667zM657.066667 256H768v110.933333V256h-110.933333zM298.666667 298.666667v426.666666h426.666666v-256l85.333334 85.333334v256H213.333333V213.333333h256l85.333334 85.333334H298.666667z"
                                fill="#000000"></path>
                        </svg>
                        <span>导出</span>
                    </button>
                </div>
                <div class="panel-row">
                    <label class="btn" for="imageInput" title="导入图片" style="display:flex;align-items:center;gap:4px;">
                        <svg viewBox="0 0 1024 1024" width="20" height="20" aria-hidden="true">
                            <path
                                d="M906.666667 160v704h-768v-704h768z m-167.061334 366.4l-216.405333 180.096-140.565333-110.890667L202.666667 741.141333V800h640v-188.117333l-103.061334-85.482667zM842.666667 224h-640v434.837333l179.477333-145.130666 139.968 110.421333 217.450667-180.906667 103.104 85.504V224z m-437.333334 42.666667a96 96 0 1 1 0 192 96 96 0 0 1 0-192z m0 64a32 32 0 1 0 0 64 32 32 0 0 0 0-64z"
                                fill="#000000"></path>
                        </svg>
                        <span>图片</span>
                    </label>
                    <input id="imageInput" type="file" accept="image/*" />
                </div>
                <div class="panel-row">
                    <button id="clearBtn" class="btn" title="清空画板" style="display:flex;align-items:center;gap:4px;">
                        <svg viewBox="0 0 1024 1024" width="15" height="15" aria-hidden="true">
                            <path
                                d="M886.401 395.097h-251.7V80.614c0-22.091-19.899-40-44.447-40H439.148c-24.547 0-44.447 17.909-44.447 40v314.483h-251.7c-22.315 0-40.404 17.909-40.404 40v506.471c0 22.091 18.09 40 40.404 40h743.4c22.315 0 40.404-17.909 40.404-40V435.097c0.001-22.092-18.089-40-40.404-40z m-10.72 536.47h-127.98V831c0-17.673-12.088-32-27-32s-27 14.327-27 32v100.567h-152V792c0-14.912-12.088-27-27-27s-27 12.088-27 27v139.567h-152V831c0-17.673-12.088-32-27-32s-27 14.327-27 32v100.567H152.597V688.332h723.084v243.235z m0-293.235H152.597V445.097H444.479V90.614h137.819v354.483H875.68v193.235z"
                                fill="#000000"></path>
                        </svg>
                        <span>清空</span>
                    </button>
                    <button id="flipHBtn" class="btn" title="水平翻转" style="display:flex;align-items:center;gap:4px;">
                        <svg viewBox="0 0 1024 1024" width="20" height="20" aria-hidden="true">
                            <path
                                d="M498.236235 180.705882c13.432471 0 24.515765 10.059294 26.142118 23.04l0.210823 3.312942v632.470588a26.352941 26.352941 0 0 1-52.495058 3.312941l-0.210824-3.312941v-632.470588c0-14.546824 11.806118-26.352941 26.352941-26.352942zM334.546824 299.851294l-210.82353 386.499765a26.352941 26.352941 0 0 0 23.130353 38.972235h210.823529a26.352941 26.352941 0 0 0 26.352942-26.352941V312.470588c0-27.316706-36.412235-36.592941-49.483294-12.619294z m-3.222589 115.922824v256.843294h-140.047059L331.294118 415.774118zM612.442353 312.470588v386.499765c0 14.576941 11.776 26.352941 26.352941 26.352941h210.82353a26.352941 26.352941 0 0 0 23.130352-38.972235l-210.823529-386.499765c-13.071059-23.973647-49.483294-14.697412-49.483294 12.619294z m52.705882 103.30353l140.047059 256.843294h-140.047059v-256.843294z"
                                fill="#000000"></path>
                        </svg>
                        <span>水平翻转</span>
                    </button>
                    <button id="flipVBtn" class="btn" title="垂直翻转" style="display:flex;align-items:center;gap:4px;">
                        <svg viewBox="0 0 1024 1024" width="20" height="20" aria-hidden="true">
                            <path
                                d="M843.294118 475.617882a26.352941 26.352941 0 0 1 3.312941 52.495059l-3.312941 0.210824H210.823529a26.352941 26.352941 0 0 1-3.312941-52.525177l3.312941-0.180706h632.470589zM325.029647 150.588235v210.82353c0 14.546824 11.776 26.352941 26.352941 26.352941H737.882353c27.316706 0 36.592941-36.442353 12.619294-49.483294l-386.499765-210.82353A26.352941 26.352941 0 0 0 325.029647 150.588235z m52.675765 44.393412l256.843294 140.077177h-256.843294V194.981647zM737.882353 616.146824H351.382588a26.352941 26.352941 0 0 0-26.352941 26.352941v210.823529a26.352941 26.352941 0 0 0 38.972235 23.130353l386.499765-210.823529c23.973647-13.071059 14.697412-49.483294-12.619294-49.483294z m-103.333647 52.705882l-256.843294 140.077176v-140.077176h256.843294z"
                                fill="#000000"></path>
                        </svg>
                        <span>垂直翻转</span>
                    </button>
                    <label class="btn" style="display:flex;align-items:center;gap:4px;" title="油漆桶">
                        <input type="checkbox" id="bucketToggle" style="margin:0;" />
                        <svg viewBox="0 0 1024 1024" width="17" height="17" aria-hidden="true">
                            <path
                                d="M378.197333 42.666667L317.866667 102.997333l90.496 90.496-331.861334 331.904a42.666667 42.666667 0 0 0 0 60.330667l362.026667 362.026667a42.666667 42.666667 0 0 0 60.330667 0l362.069333-362.026667a42.666667 42.666667 0 0 0 0-60.330667L378.197333 42.666667z m-211.2 512.853333l301.696-301.653333 301.696 301.653333-301.653333 301.738667-301.738667-301.696z"
                                fill="#000000"></path>
                            <path
                                d="M896 682.666667l75.434667 75.434666a106.666667 106.666667 0 1 1-150.869334 0L896 682.666667z"
                                fill="#000000"></path>
                        </svg>
                        <span>油漆桶</span>
                    </label>
                    <label class="btn" style="display:flex;align-items:center;gap:4px;" title="笔刷粗细(像素)">
                        <span>笔刷粗细</span>
                        <input type="number" id="brushSizeInput" min="1" max="10" value="2"
                            style="width:48px;padding:0 2px;" />
                    </label>
                    <button id="undoBtn" class="btn" title="撤销" style="display:flex;align-items:center;gap:4px;">
                        <svg viewBox="0 0 1024 1024" width="17" height="17" aria-hidden="true">
                            <path
                                d="M384 192L128 448l256 256V512h256c106.039 0 192 85.961 192 192 0 106.039-85.961 192-192 192H448v96h192c159.058 0 288-128.942 288-288S799.058 416 640 416H384V192z"
                                fill="#000000"></path>
                        </svg>
                        <span>撤销</span>
                    </button>
                    <button id="redoBtn" class="btn" title="重做" style="display:flex;align-items:center;gap:4px;">
                        <svg viewBox="0 0 1024 1024" width="17" height="17" aria-hidden="true">
                            <path
                                d="M640 192v224H384c-159.058 0-288 128.942-288 288s128.942 288 288 288h192v-96H384c-106.039 0-192-85.961-192-192 0-106.039 85.961-192 192-192h256v192l256-256L640 192z"
                                fill="#000000"></path>
                        </svg>
                        <span>重做</span>
                    </button>
                    <button id="denoiseBtn" class="btn" title="边缘去噪" style="display:flex;align-items:center;gap:4px;">
                        <svg viewBox="0 0 1024 1024" width="17" height="17" aria-hidden="true">
                            <path
                                d="M512.483556 113.294222c15.957333 0 28.928 12.942222 28.928 28.928v127.089778a28.928 28.928 0 1 1-57.856 0V142.222222c0-15.985778 12.942222-28.928 28.928-28.928z m0 545.962667c15.957333 0 28.928 12.942222 28.928 28.899555v127.089778a28.928 28.928 0 0 1-57.856 0v-127.089778c0-15.957333 12.942222-28.899556 28.928-28.899555z m20.451555-196.266667L864.711111 794.794667a28.928 28.928 0 0 1-40.874667 40.903111L492.032 503.893333a28.928 28.928 0 1 1 40.903111-40.903111z m311.352889-8.476444a28.928 28.928 0 0 1 0 57.856h-127.089778a28.928 28.928 0 1 1 0-57.856h127.089778zM142.336 483.441778c0-15.985778 12.970667-28.928 28.928-28.928h127.089778a28.928 28.928 0 0 1 0 57.856H171.264a28.928 28.928 0 0 1-28.928-28.928z m108.430222 261.717333a28.928 28.928 0 0 1 0-40.903111l89.884445-89.884444a28.928 28.928 0 0 1 40.874666 40.931555l-89.884444 89.884445a28.928 28.928 0 0 1-40.874667 0z m386.019556-386.048a28.928 28.928 0 0 1 0-40.874667l89.884444-89.884444a28.928 28.928 0 0 1 40.903111 40.903111l-89.884444 89.884445a28.928 28.928 0 0 1-40.903111 0z m-248.604445 0a28.928 28.928 0 0 1-40.903111 0l-89.884444-89.856a28.928 28.928 0 1 1 40.903111-40.903111l89.884444 89.884444c11.292444 11.292444 11.292444 29.582222 0 40.874667z"
                                fill="#000000"></path>
                        </svg>
                        <span>边缘去噪</span>
                    </button>
                </div>

            </div>

            <div class="panel-section" id="palette">
                <div class="panel-row">
                    <button data-color="0" class="active">
                        <svg t="1770526692878" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="9378" width="20" height="20"
                            style="display:inline-block;">
                            <path
                                d="M987.7 428.36L582.9 82.72 73.68 679.13l280.25 239.32 18.1-0.18h477.26v-93.09H648.88L987.7 428.36zM204.9 668.77l178.15-208.64 263.22 224.75-118.44 138.7L387.88 825 204.9 668.77z"
                                p-id="9379" fill="#000000"></path>
                        </svg>
                    </button>
                </div>
                <div class="panel-row">
                    <button data-color="1">
                        <svg t="1770526661803" class="icon" viewBox="0 0 1025 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8135" width="20" height="20"
                            style="display:inline-block;">
                            <path
                                d="M940.64 82.56c-52.64-52.576-121.952-82.56-190.272-82.56-57.632 0-110.688 21.376-149.44 60.064l-155.744 156.928c-0.48 0.448-1.024 0.736-1.504 1.216-0.256 0.256-0.416 0.608-0.672 0.832l0.064 0.064-330.528 333.088c-15.232 15.136-26.272 33.984-32.416 54.56l-75.168 272.256c-0.064 0.736-4.96 22.112-4.96 32.992 0 61.824 50.208 112 112.128 112 12.32 0 36.16-5.888 37.024-6.016l271.296-71.328c20.608-6.112 39.328-17.248 54.56-32.512l488.416-492.256c88.832-88.896 78.816-237.888-22.784-339.328zM512.448 761.44c-2.624-28.864-10.784-57.184-23.008-84.064l302.56-302.528c18.496 58.432 8.992 119.552-31.552 160.128-0.256 0.256-0.576 0.416-0.8 0.672l0.448 0.416-247.296 249.28c0-7.968 0.384-15.776-0.352-23.904zM473.376 648.192c-11.936-19.616-25.504-38.56-42.304-55.328-19.552-19.552-41.984-34.88-65.408-47.744l305.024-305.024c23.936 10.624 46.88 25.76 67.136 46.016 17.312 17.248 30.688 36.576 40.992 56.672l-305.44 305.408zM335.552 529.984c-29.632-11.936-60.672-18.752-91.776-19.168l246.496-248.384c37.728-36.8 92.672-47.392 146.784-33.984l-301.504 301.536zM133.344 955.936c-3.488 0.8-14.336 3.552-21.696 4.064-26.304-0.32-47.648-21.696-47.648-48 0.384-5.376 2.528-14.624 3.264-17.984l33.696-122.048c36.576-0.992 75.936 13.248 106.88 44.256 31.424 31.36 46.208 71.488 44.608 108.512l-119.104 31.2zM283.968 916.384c-0.768-42.944-18.24-87.616-53.504-122.816-33.344-33.376-76.992-52.64-120.512-54.368l31.872-115.424c2.304-7.68 6.88-15.264 12.512-21.888 64.192-45.952 162.912-32.384 231.488 36.256 72.544 72.512 83.744 178.752 27.872 242.176-3.712 1.952-7.456 3.808-11.488 4.992l-118.24 31.072zM918.112 376.704l-53.888 54.304c0-7.232 0.864-14.176 0.192-21.568-5.632-61.92-34.496-121.792-81.376-168.608-52.128-52.16-121.248-82.08-189.696-82.272l52.992-53.44c26.528-26.464 63.552-41.12 104.032-41.12 51.488 0 104.384 23.296 145.056 63.84 38.176 38.112 60.928 85.472 64.192 133.376 3.008 44.704-11.744 85.696-41.504 115.488z"
                                fill="#000000" p-id="8136"></path>
                        </svg>
                    </button>
                    <button data-color="2">
                        <svg t="1770526661803" class="icon" viewBox="0 0 1025 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8135" width="20" height="20"
                            style="display:inline-block;">
                            <path
                                d="M940.64 82.56c-52.64-52.576-121.952-82.56-190.272-82.56-57.632 0-110.688 21.376-149.44 60.064l-155.744 156.928c-0.48 0.448-1.024 0.736-1.504 1.216-0.256 0.256-0.416 0.608-0.672 0.832l0.064 0.064-330.528 333.088c-15.232 15.136-26.272 33.984-32.416 54.56l-75.168 272.256c-0.064 0.736-4.96 22.112-4.96 32.992 0 61.824 50.208 112 112.128 112 12.32 0 36.16-5.888 37.024-6.016l271.296-71.328c20.608-6.112 39.328-17.248 54.56-32.512l488.416-492.256c88.832-88.896 78.816-237.888-22.784-339.328zM512.448 761.44c-2.624-28.864-10.784-57.184-23.008-84.064l302.56-302.528c18.496 58.432 8.992 119.552-31.552 160.128-0.256 0.256-0.576 0.416-0.8 0.672l0.448 0.416-247.296 249.28c0-7.968 0.384-15.776-0.352-23.904zM473.376 648.192c-11.936-19.616-25.504-38.56-42.304-55.328-19.552-19.552-41.984-34.88-65.408-47.744l305.024-305.024c23.936 10.624 46.88 25.76 67.136 46.016 17.312 17.248 30.688 36.576 40.992 56.672l-305.44 305.408zM335.552 529.984c-29.632-11.936-60.672-18.752-91.776-19.168l246.496-248.384c37.728-36.8 92.672-47.392 146.784-33.984l-301.504 301.536zM133.344 955.936c-3.488 0.8-14.336 3.552-21.696 4.064-26.304-0.32-47.648-21.696-47.648-48 0.384-5.376 2.528-14.624 3.264-17.984l33.696-122.048c36.576-0.992 75.936 13.248 106.88 44.256 31.424 31.36 46.208 71.488 44.608 108.512l-119.104 31.2zM283.968 916.384c-0.768-42.944-18.24-87.616-53.504-122.816-33.344-33.376-76.992-52.64-120.512-54.368l31.872-115.424c2.304-7.68 6.88-15.264 12.512-21.888 64.192-45.952 162.912-32.384 231.488 36.256 72.544 72.512 83.744 178.752 27.872 242.176-3.712 1.952-7.456 3.808-11.488 4.992l-118.24 31.072zM918.112 376.704l-53.888 54.304c0-7.232 0.864-14.176 0.192-21.568-5.632-61.92-34.496-121.792-81.376-168.608-52.128-52.16-121.248-82.08-189.696-82.272l52.992-53.44c26.528-26.464 63.552-41.12 104.032-41.12 51.488 0 104.384 23.296 145.056 63.84 38.176 38.112 60.928 85.472 64.192 133.376 3.008 44.704-11.744 85.696-41.504 115.488z"
                                fill="#fec77f" p-id="8136"></path>
                        </svg>
                    </button>
                </div>
                <div class="panel-row">
                    <button data-color="3">
                        <svg t="1770526661803" class="icon" viewBox="0 0 1025 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8135" width="20" height="20"
                            style="display:inline-block;">
                            <path
                                d="M940.64 82.56c-52.64-52.576-121.952-82.56-190.272-82.56-57.632 0-110.688 21.376-149.44 60.064l-155.744 156.928c-0.48 0.448-1.024 0.736-1.504 1.216-0.256 0.256-0.416 0.608-0.672 0.832l0.064 0.064-330.528 333.088c-15.232 15.136-26.272 33.984-32.416 54.56l-75.168 272.256c-0.064 0.736-4.96 22.112-4.96 32.992 0 61.824 50.208 112 112.128 112 12.32 0 36.16-5.888 37.024-6.016l271.296-71.328c20.608-6.112 39.328-17.248 54.56-32.512l488.416-492.256c88.832-88.896 78.816-237.888-22.784-339.328zM512.448 761.44c-2.624-28.864-10.784-57.184-23.008-84.064l302.56-302.528c18.496 58.432 8.992 119.552-31.552 160.128-0.256 0.256-0.576 0.416-0.8 0.672l0.448 0.416-247.296 249.28c0-7.968 0.384-15.776-0.352-23.904zM473.376 648.192c-11.936-19.616-25.504-38.56-42.304-55.328-19.552-19.552-41.984-34.88-65.408-47.744l305.024-305.024c23.936 10.624 46.88 25.76 67.136 46.016 17.312 17.248 30.688 36.576 40.992 56.672l-305.44 305.408zM335.552 529.984c-29.632-11.936-60.672-18.752-91.776-19.168l246.496-248.384c37.728-36.8 92.672-47.392 146.784-33.984l-301.504 301.536zM133.344 955.936c-3.488 0.8-14.336 3.552-21.696 4.064-26.304-0.32-47.648-21.696-47.648-48 0.384-5.376 2.528-14.624 3.264-17.984l33.696-122.048c36.576-0.992 75.936 13.248 106.88 44.256 31.424 31.36 46.208 71.488 44.608 108.512l-119.104 31.2zM283.968 916.384c-0.768-42.944-18.24-87.616-53.504-122.816-33.344-33.376-76.992-52.64-120.512-54.368l31.872-115.424c2.304-7.68 6.88-15.264 12.512-21.888 64.192-45.952 162.912-32.384 231.488 36.256 72.544 72.512 83.744 178.752 27.872 242.176-3.712 1.952-7.456 3.808-11.488 4.992l-118.24 31.072zM918.112 376.704l-53.888 54.304c0-7.232 0.864-14.176 0.192-21.568-5.632-61.92-34.496-121.792-81.376-168.608-52.128-52.16-121.248-82.08-189.696-82.272l52.992-53.44c26.528-26.464 63.552-41.12 104.032-41.12 51.488 0 104.384 23.296 145.056 63.84 38.176 38.112 60.928 85.472 64.192 133.376 3.008 44.704-11.744 85.696-41.504 115.488z"
                                fill="#ff9981" p-id="8136"></path>
                        </svg>
                    </button>
                    <button data-color="4">
                        <svg t="1770526661803" class="icon" viewBox="0 0 1025 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8135" width="20" height="20"
                            style="display:inline-block;">
                            <path
                                d="M940.64 82.56c-52.64-52.576-121.952-82.56-190.272-82.56-57.632 0-110.688 21.376-149.44 60.064l-155.744 156.928c-0.48 0.448-1.024 0.736-1.504 1.216-0.256 0.256-0.416 0.608-0.672 0.832l0.064 0.064-330.528 333.088c-15.232 15.136-26.272 33.984-32.416 54.56l-75.168 272.256c-0.064 0.736-4.96 22.112-4.96 32.992 0 61.824 50.208 112 112.128 112 12.32 0 36.16-5.888 37.024-6.016l271.296-71.328c20.608-6.112 39.328-17.248 54.56-32.512l488.416-492.256c88.832-88.896 78.816-237.888-22.784-339.328zM512.448 761.44c-2.624-28.864-10.784-57.184-23.008-84.064l302.56-302.528c18.496 58.432 8.992 119.552-31.552 160.128-0.256 0.256-0.576 0.416-0.8 0.672l0.448 0.416-247.296 249.28c0-7.968 0.384-15.776-0.352-23.904zM473.376 648.192c-11.936-19.616-25.504-38.56-42.304-55.328-19.552-19.552-41.984-34.88-65.408-47.744l305.024-305.024c23.936 10.624 46.88 25.76 67.136 46.016 17.312 17.248 30.688 36.576 40.992 56.672l-305.44 305.408zM335.552 529.984c-29.632-11.936-60.672-18.752-91.776-19.168l246.496-248.384c37.728-36.8 92.672-47.392 146.784-33.984l-301.504 301.536zM133.344 955.936c-3.488 0.8-14.336 3.552-21.696 4.064-26.304-0.32-47.648-21.696-47.648-48 0.384-5.376 2.528-14.624 3.264-17.984l33.696-122.048c36.576-0.992 75.936 13.248 106.88 44.256 31.424 31.36 46.208 71.488 44.608 108.512l-119.104 31.2zM283.968 916.384c-0.768-42.944-18.24-87.616-53.504-122.816-33.344-33.376-76.992-52.64-120.512-54.368l31.872-115.424c2.304-7.68 6.88-15.264 12.512-21.888 64.192-45.952 162.912-32.384 231.488 36.256 72.544 72.512 83.744 178.752 27.872 242.176-3.712 1.952-7.456 3.808-11.488 4.992l-118.24 31.072zM918.112 376.704l-53.888 54.304c0-7.232 0.864-14.176 0.192-21.568-5.632-61.92-34.496-121.792-81.376-168.608-52.128-52.16-121.248-82.08-189.696-82.272l52.992-53.44c26.528-26.464 63.552-41.12 104.032-41.12 51.488 0 104.384 23.296 145.056 63.84 38.176 38.112 60.928 85.472 64.192 133.376 3.008 44.704-11.744 85.696-41.504 115.488z"
                                fill="#dae190" p-id="8136"></path>
                        </svg>
                    </button>
                </div>
                <div class="panel-row">
                    <button data-color="5">
                        <svg t="1770526661803" class="icon" viewBox="0 0 1025 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="8135" width="20" height="20"
                            style="display:inline-block;">
                            <path
                                d="M940.64 82.56c-52.64-52.576-121.952-82.56-190.272-82.56-57.632 0-110.688 21.376-149.44 60.064l-155.744 156.928c-0.48 0.448-1.024 0.736-1.504 1.216-0.256 0.256-0.416 0.608-0.672 0.832l0.064 0.064-330.528 333.088c-15.232 15.136-26.272 33.984-32.416 54.56l-75.168 272.256c-0.064 0.736-4.96 22.112-4.96 32.992 0 61.824 50.208 112 112.128 112 12.32 0 36.16-5.888 37.024-6.016l271.296-71.328c20.608-6.112 39.328-17.248 54.56-32.512l488.416-492.256c88.832-88.896 78.816-237.888-22.784-339.328zM512.448 761.44c-2.624-28.864-10.784-57.184-23.008-84.064l302.56-302.528c18.496 58.432 8.992 119.552-31.552 160.128-0.256 0.256-0.576 0.416-0.8 0.672l0.448 0.416-247.296 249.28c0-7.968 0.384-15.776-0.352-23.904zM473.376 648.192c-11.936-19.616-25.504-38.56-42.304-55.328-19.552-19.552-41.984-34.88-65.408-47.744l305.024-305.024c23.936 10.624 46.88 25.76 67.136 46.016 17.312 17.248 30.688 36.576 40.992 56.672l-305.44 305.408zM335.552 529.984c-29.632-11.936-60.672-18.752-91.776-19.168l246.496-248.384c37.728-36.8 92.672-47.392 146.784-33.984l-301.504 301.536zM133.344 955.936c-3.488 0.8-14.336 3.552-21.696 4.064-26.304-0.32-47.648-21.696-47.648-48 0.384-5.376 2.528-14.624 3.264-17.984l33.696-122.048c36.576-0.992 75.936 13.248 106.88 44.256 31.424 31.36 46.208 71.488 44.608 108.512l-119.104 31.2zM283.968 916.384c-0.768-42.944-18.24-87.616-53.504-122.816-33.344-33.376-76.992-52.64-120.512-54.368l31.872-115.424c2.304-7.68 6.88-15.264 12.512-21.888 64.192-45.952 162.912-32.384 231.488 36.256 72.544 72.512 83.744 178.752 27.872 242.176-3.712 1.952-7.456 3.808-11.488 4.992l-118.24 31.072zM918.112 376.704l-53.888 54.304c0-7.232 0.864-14.176 0.192-21.568-5.632-61.92-34.496-121.792-81.376-168.608-52.128-52.16-121.248-82.08-189.696-82.272l52.992-53.44c26.528-26.464 63.552-41.12 104.032-41.12 51.488 0 104.384 23.296 145.056 63.84 38.176 38.112 60.928 85.472 64.192 133.376 3.008 44.704-11.744 85.696-41.504 115.488z"
                                fill="#c8daed" p-id="8136"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">图片容差</div>
                <div class="panel-row">
                    <input type="range" id="toleranceRange" min="0" max="442" value="100" />
                    <span id="toleranceLabel">容差: 100</span>
                    <button id="toleranceRefresh" class="btn">刷新</button>
                </div>
            </div>

        </aside>

        <main class="board-frame">
            <div id="canvasWrapper">
                <!-- 默认大小与游戏黑板一致：332 × 192 像素格，CELL_SIZE = 3 时画布为 996 × 576 -->
                <canvas id="board" width="996" height="576"></canvas>
            </div>
        </main>
    </div>

    <script>
        const CELL_SIZE = 3; // 单个逻辑像素显示尺寸

        const COLOR_MAP = {
            0: "#6c684d",      // 空 / 背景：使用黑板颜色
            1: "#ffdfdb",      // 粉色粉笔
            2: "#fec77f",      // 橙黄粉笔
            3: "#ff9981",      // 橘红粉笔
            4: "#dae190",      // 浅黄绿粉笔
            5: "#c8daed"       // 浅蓝灰粉笔
        };

        let version = 1;
        let width = 320;   // 默认尺寸：与导入自游戏的黑板分辨率一致
        let height = 180;

        let grid = [];
        let currentColor = 0;
        let isDrawing = false;
        let currentFilename = "CopyPaintBoard.dat";

        // 撤销/重做历史栈
        const undoStack = [];
        const redoStack = [];

        const canvas = document.getElementById("board");
        const ctx = canvas.getContext("2d");
        const fileInput = document.getElementById("fileInput");
        const imageInput = document.getElementById("imageInput");
        const saveBtn = document.getElementById("saveBtn");
        const clearBtn = document.getElementById("clearBtn");
        const flipHBtn = document.getElementById("flipHBtn");
        const flipVBtn = document.getElementById("flipVBtn");
        const bucketToggle = document.getElementById("bucketToggle");
        const brushSizeInput = document.getElementById("brushSizeInput");

        const undoBtn = document.getElementById("undoBtn");
        const redoBtn = document.getElementById("redoBtn");
        const denoiseBtn = document.getElementById("denoiseBtn");

        const palette = document.getElementById("palette");
        const info = document.getElementById("info");

        // 容差设置（RGB 距离阈值）
        let tolerance = 100;
        const toleranceRange = document.getElementById("toleranceRange");
        const toleranceLabel = document.getElementById("toleranceLabel");
        const toleranceRefreshBtn = document.getElementById("toleranceRefresh");
        let lastImageData = null; // 缓存 160x90 的 ImageData
        let lastImageName = "";

        if (toleranceRange) {
            toleranceRange.addEventListener("input", e => {
                tolerance = parseInt(e.target.value, 10) || 0;
                toleranceLabel.textContent = `容差: ${tolerance}`;
            });
        }

        if (toleranceRefreshBtn) {
            toleranceRefreshBtn.addEventListener("click", () => {
                if (!lastImageData) {
                    info.textContent = '没有可刷新的图片数据';
                    return;
                }
                pushHistory();
                applyImageData(lastImageData, lastImageName, true);
            });
        }

        function initGrid(w, h) {
            width = w;
            height = h;
            grid = new Array(width);
            for (let x = 0; x < width; x++) {
                grid[x] = new Array(height).fill(0);
            }
            resizeCanvas();
            drawAll();
            info.textContent = `尺寸: ${width} × ${height}`;
        }

        function resizeCanvas() {
            canvas.width = width * CELL_SIZE;
            canvas.height = height * CELL_SIZE;
        }

        function drawAll() {
            for (let x = 0; x < width; x++) {
                for (let y = 0; y < height; y++) {
                    drawCell(x, y);
                }
            }
        }

        function drawCell(x, y) {
            const v = grid[x]?.[y] ?? 0;
            ctx.fillStyle = COLOR_MAP[v] || "#000000";
            ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
        }

        function canvasToCellCoords(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((clientX - rect.left) / CELL_SIZE);
            const y = Math.floor((clientY - rect.top) / CELL_SIZE);
            if (x < 0 || x >= width || y < 0 || y >= height) return null;
            return { x, y };
        }

        function setCell(x, y, colorIndex) {
            if (x < 0 || x >= width || y < 0 || y >= height) return;
            if (grid[x][y] === colorIndex) return;
            grid[x][y] = colorIndex;
            drawCell(x, y);
        }

        // 复制当前网格状态
        function cloneGridState() {
            return {
                width,
                height,
                grid: grid.map(col => col.slice())
            };
        }

        // 从保存的状态恢复网格
        function restoreGridState(state) {
            width = state.width;
            height = state.height;
            grid = state.grid.map(col => col.slice());
            resizeCanvas();
            drawAll();
            info.textContent = `尺寸: ${width} × ${height}`;
        }

        // 记录历史（用户主动操作前调用）
        function pushHistory() {
            undoStack.push(cloneGridState());
            // 一旦有新操作，重做栈清空
            redoStack.length = 0;
        }

        // 笔刷粗细（像素），用方形 size×size 画笔
        let brushSize = 2;

        function applyBrushSizeFromInput() {
            if (!brushSizeInput) return;
            let v = parseInt(brushSizeInput.value, 10);
            if (!Number.isFinite(v)) v = 2;
            if (v < 1) v = 1;
            if (v > 10) v = 10;
            brushSize = v;
            brushSizeInput.value = String(v);
        }

        // 根据当前笔刷粗细画一笔（size×size 方块），橡皮同样生效
        function paintAt(x, y, colorIndex) {
            const half = Math.floor(brushSize / 2);
            const startX = x - half;
            const startY = y - half;
            for (let dx = 0; dx < brushSize; dx++) {
                for (let dy = 0; dy < brushSize; dy++) {
                    setCell(startX + dx, startY + dy, colorIndex);
                }
            }
        }

        // 油漆桶填充（四方向泛洪）
        function floodFill(startX, startY, colorIndex) {
            if (startX < 0 || startX >= width || startY < 0 || startY >= height) return;
            const targetColor = grid[startX][startY];
            if (targetColor === colorIndex) return;

            const stack = [[startX, startY]];
            const visited = new Set();

            while (stack.length > 0) {
                const [x, y] = stack.pop();
                const key = x + "," + y;
                if (visited.has(key)) continue;
                visited.add(key);

                if (x < 0 || x >= width || y < 0 || y >= height) continue;
                if (grid[x][y] !== targetColor) continue;

                grid[x][y] = colorIndex;

                stack.push([x + 1, y]);
                stack.push([x - 1, y]);
                stack.push([x, y + 1]);
                stack.push([x, y - 1]);
            }

            drawAll();
        }

        // 导入 dat（注意：文件中的 y=0 在底部，这里读入时做一次上下翻转，方便在网页里正常查看）
        fileInput.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            currentFilename = file.name || "CopyPaintBoard.dat";

            const reader = new FileReader();
            reader.onload = evt => {
                const buf = evt.target.result;
                const view = new DataView(buf);
                const fileSize = buf.byteLength;

                let offset = 0;
                version = view.getInt32(offset, true); offset += 4;
                const w = view.getInt32(offset, true); offset += 4;
                const h = view.getInt32(offset, true); offset += 4;

                // 计算理论上应该的文件大小
                const expectedSize = 3 * 4 + w * h * 4;

                // 输出详细信息
                console.log(`=== DAT 文件信息 ===`);
                console.log(`文件名: ${currentFilename}`);
                console.log(`文件字节总数: ${fileSize}`);
                console.log(`version: ${version}`);
                console.log(`width: ${w} 像素`);
                console.log(`height: ${h} 像素`);
                console.log(`尺寸: ${w} × ${h} = ${w * h} 个像素点`);
                console.log(`理论文件大小: ${expectedSize} 字节`);
                console.log(`文件大小是否匹配: ${fileSize === expectedSize ? '✓ 是' : '✗ 否 (可能文件损坏)'}`);
                console.log(`像素数据大小: ${w * h * 4} 字节 = ${(w * h * 4 / 1024).toFixed(2)} KB`);

                initGrid(w, h);

                for (let x = 0; x < width; x++) {
                    for (let y = 0; y < height; y++) {
                        const v = view.getInt32(offset, true);
                        offset += 4;
                        const yy = height - 1 - y; // 文件的 y=0 在底部，这里翻转成网页坐标的顶部
                        grid[x][yy] = v;
                    }
                }

                drawAll();
                info.textContent = `导入: ${currentFilename} | 版本=${version} | 尺寸=${width}×${height} | 总大小=${fileSize}字节`;
            };
            reader.readAsArrayBuffer(file);
            e.target.value = "";
        });

        // 导出 dat（再次上下翻转，保持与游戏内 CopyPaintBoard.dat 完全相同的存储方式）
        saveBtn.addEventListener("click", () => {
            const totalInts = 3 + width * height;
            const buf = new ArrayBuffer(totalInts * 4);
            const view = new DataView(buf);
            let offset = 0;

            view.setInt32(offset, 1, true); offset += 4; // version 固定 1
            view.setInt32(offset, width, true); offset += 4;
            view.setInt32(offset, height, true); offset += 4;

            for (let x = 0; x < width; x++) {
                for (let y = 0; y < height; y++) {
                    const yy = height - 1 - y; // 写回文件时还原成底部为 y=0 的坐标
                    const v = grid[x][yy] | 0;
                    view.setInt32(offset, v, true);
                    offset += 4;
                }
            }

            const blob = new Blob([buf], { type: "application/octet-stream" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = currentFilename || "CopyPaintBoard.dat";
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(a.href);
        });

        // 清空
        clearBtn.addEventListener("click", () => {
            pushHistory();
            for (let x = 0; x < width; x++) {
                grid[x].fill(0);
            }
            drawAll();
        });

        // 水平翻转
        flipHBtn.addEventListener("click", () => {
            pushHistory();
            const half = Math.floor(width / 2);

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < half; x++) {
                    const nx = width - 1 - x;
                    const tmp = grid[x][y];
                    grid[x][y] = grid[nx][y];
                    grid[nx][y] = tmp;
                }
            }
            drawAll();
        });

        // 垂直翻转
        flipVBtn.addEventListener("click", () => {
            pushHistory();
            const half = Math.floor(height / 2);

            for (let x = 0; x < width; x++) {
                for (let y = 0; y < half; y++) {
                    const ny = height - 1 - y;
                    const tmp = grid[x][y];
                    grid[x][y] = grid[x][ny];
                    grid[x][ny] = tmp;
                }
            }
            drawAll();
        });

        let useBucket = false; // 是否启用油漆桶

        // 油漆桶勾选项
        if (bucketToggle) {
            bucketToggle.addEventListener("change", e => {
                useBucket = !!e.target.checked;
            });
        }

        // 笔刷粗细输入
        if (brushSizeInput) {
            applyBrushSizeFromInput();
            brushSizeInput.addEventListener("change", applyBrushSizeFromInput);
        }

        // 撤销 / 重做按钮
        if (undoBtn) {
            undoBtn.addEventListener("click", () => {
                if (undoStack.length === 0) return;
                const prev = undoStack.pop();
                redoStack.push(cloneGridState());
                restoreGridState(prev);
            });
        }

        if (redoBtn) {
            redoBtn.addEventListener("click", () => {
                if (redoStack.length === 0) return;
                const next = redoStack.pop();
                undoStack.push(cloneGridState());
                restoreGridState(next);
            });
        }

        // 边缘去噪：用邻域多数颜色清理噪点
        function denoiseOnce() {
            const newGrid = new Array(width);
            for (let x = 0; x < width; x++) {
                newGrid[x] = new Array(height);
            }

            for (let x = 0; x < width; x++) {
                for (let y = 0; y < height; y++) {
                    const current = grid[x][y];

                    const counts = new Map();
                    function addColor(c) {
                        counts.set(c, (counts.get(c) || 0) + 1);
                    }

                    // 统计 8 邻域颜色
                    for (let dx = -1; dx <= 1; dx++) {
                        for (let dy = -1; dy <= 1; dy++) {
                            if (dx === 0 && dy === 0) continue;
                            const nx = x + dx;
                            const ny = y + dy;
                            if (nx < 0 || nx >= width || ny < 0 || ny >= height) continue;
                            addColor(grid[nx][ny]);
                        }
                    }

                    const selfCount = counts.get(current) || 0;

                    let bestColor = current;
                    let bestCount = selfCount;
                    for (const [c, cnt] of counts.entries()) {
                        if (cnt > bestCount) {
                            bestCount = cnt;
                            bestColor = c;
                        }
                    }

                    if (selfCount <= 1 && bestCount >= 3 && bestColor !== current) {
                        newGrid[x][y] = bestColor;
                    } else {
                        newGrid[x][y] = current;
                    }
                }
            }

            grid = newGrid;
            drawAll();
        }

        // 边缘去噪按钮
        if (denoiseBtn) {
            denoiseBtn.addEventListener("click", () => {
                pushHistory();
                denoiseOnce();
            });
        }

        // 调色板
        palette.addEventListener("click", e => {
            const btn = e.target.closest("button[data-color]");
            if (!btn) return;
            currentColor = parseInt(btn.getAttribute("data-color"), 10);
            Array.from(palette.querySelectorAll("button[data-color]"))
                .forEach(b => b.classList.toggle("active", b === btn));
        });

        // 颜色距离计算（RGB欧几里得距离）
        function colorDistance(r1, g1, b1, r2, g2, b2) {
            return Math.sqrt((r1 - r2) ** 2 + (g1 - g2) ** 2 + (b1 - b2) ** 2);
        }

        // 获取最接近的颜色索引（返回按距离升序排序的数组）
        function findClosestColor(r, g, b) {
            const colorRGB = {
                0: [108, 104, 77],      // 背景
                1: [255, 223, 219],     // 粉色
                2: [254, 199, 127],     // 橙黄
                3: [255, 153, 129],     // 橘红
                4: [218, 225, 144],     // 黄绿
                5: [200, 218, 237]      // 蓝灰
            };

            const arr = [];
            for (let colorIdx in colorRGB) {
                const [cr, cg, cb] = colorRGB[colorIdx];
                const dist = colorDistance(r, g, b, cr, cg, cb);
                arr.push({ idx: parseInt(colorIdx, 10), dist });
            }

            arr.sort((a, b) => a.dist - b.dist);
            return arr;
        }

        // 新图片处理（缩放到 320×180，不拉伸）
        imageInput.addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = evt => {
                const img = new Image();
                img.onload = () => {
                    const targetW = 320;
                    const targetH = 180;
                    const tempCanvas = document.createElement("canvas");
                    const tempCtx = tempCanvas.getContext("2d");
                    tempCanvas.width = targetW;
                    tempCanvas.height = targetH;

                    // 用黑板底色填充空白区域
                    tempCtx.fillStyle = "#6c684d";
                    tempCtx.fillRect(0, 0, targetW, targetH);

                    // 等比缩放并居中绘制，避免拉伸
                    const scale = Math.min(targetW / img.width, targetH / img.height);
                    const drawW = img.width * scale;
                    const drawH = img.height * scale;
                    const offsetX = (targetW - drawW) / 2;
                    const offsetY = (targetH - drawH) / 2;
                    tempCtx.drawImage(img, 0, 0, img.width, img.height, offsetX, offsetY, drawW, drawH);

                    // 获取像素数据（320×180，一像素对应一格）
                    const imageData = tempCtx.getImageData(0, 0, targetW, targetH);
                    lastImageData = imageData;
                    lastImageName = file.name || "(image)";

                    pushHistory();
                    applyImageData(imageData, file.name);
                };
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = "";
        });

        // 画笔 / 油漆桶交互
        canvas.addEventListener("mousedown", e => {
            const pos = canvasToCellCoords(e.clientX, e.clientY);
            if (!pos) return;

            if (useBucket) {
                pushHistory();
                floodFill(pos.x, pos.y, currentColor);
                isDrawing = false;
            } else {
                pushHistory();
                isDrawing = true;
                paintAt(pos.x, pos.y, currentColor);
            }
        });

        window.addEventListener("mouseup", () => {
            isDrawing = false;
        });

        canvas.addEventListener("mousemove", e => {
            if (!isDrawing || useBucket) return;
            const pos = canvasToCellCoords(e.clientX, e.clientY);
            if (!pos) return;
            paintAt(pos.x, pos.y, currentColor);
        });

        // 初始化默认空板
        initGrid(width, height);

        // 将图片 ImageData 转换并应用到网格（可复用，支持刷新）
        function applyImageData(imageData, name, isRefresh = false) {
            const data = imageData.data;

            // 初始化画板为 320×180，一像素对应一格
            const targetW = 320;
            const targetH = 180;
            initGrid(targetW, targetH);

            // 转换并填充（320×180，取消 2×2 最小单位）
            for (let y = 0; y < targetH; y++) {
                for (let x = 0; x < targetW; x++) {
                    const idx = (y * targetW + x) * 4;
                    const r = data[idx];
                    const g = data[idx + 1];
                    const b = data[idx + 2];

                    const matches = findClosestColor(r, g, b); // 已按距离升序

                    // 计算背景与非背景的距离，做统一的“贪心”判定
                    let distBg = Infinity;
                    let bestNonBg = null; // { idx, dist }
                    for (const m of matches) {
                        if (m.idx === 0 && distBg === Infinity) {
                            distBg = m.dist;
                        } else if (m.idx !== 0 && !bestNonBg) {
                            bestNonBg = m;
                        }
                    }

                    let colorIndex = 0;

                    if (bestNonBg) {
                        if (bestNonBg.dist <= tolerance) {
                            colorIndex = bestNonBg.idx;
                        } else if (distBg <= tolerance && distBg + 5 < bestNonBg.dist) {
                            colorIndex = 0;
                        } else {
                            colorIndex = 0;
                        }
                    } else if (distBg <= tolerance) {
                        colorIndex = 0;
                    } else {
                        colorIndex = 0;
                    }

                    grid[x][y] = colorIndex;
                }
            }

            drawAll();
            info.textContent = `${isRefresh ? '已刷新图片' : '已加载图片'}: ${name || ''} (320×180) | 容差=${tolerance}`;
        }
    </script>

    <div style="text-align:center;font-size:11px;color:#888;margin-top:8px;">
        made by
        <a href="https://github.com/ZTMYO" target="_blank" rel="noopener noreferrer"
            style="font-weight:bold;text-decoration:none;">ZTMYO</a>
    </div>
</body>

</html>